var registerType = 1;

$().ready(function() {

    $(".login-register-form .input-text").placeholder();
    initMobileControls();
    //initMailControls();
    initPassShow();
    $(".hz-tab-menu-item").click(function() {
        handlerRegisterTitle(this)
    });
    $(".login-action").click(function() {
        submitRegister();
    });
});

function existsTxtMobile() {
		return existsControlValue("txtMobile", existMobile, "您输入的手机已经被注册过，请重新输入新的手机号");
}

function existsTxtMail() {
	return existsControlValue("txtMobile", existMail, "您输入的邮箱已经被注册过，请重新输入新的邮箱");
}

function existsTxtVerify(){
	return existsControlValue("txtMobileVerify",verifyimag,"您输入的验证码不正确");
}
function initMobileControls() {
    $("#getSmsCode").click(function() {
        if (smsSecond > 0) {
            return
        }
        var c = existsTxtVerify();
        if (c && c != "") {
        	 $("#mobileErrMsg").text(c);
             return
        }
        var b = $("#txtMobile");
        
        a = existsTxtMobile();
        if (a && a != "") {
                $("#mobileErrMsg").text(a);
                return
        }
         sendRegisterSms($.trim(b.val()), $.trim($("#txtMobileVerify").val()));

    });
    $("#txtMobilePassword").keyup(function() {
        passwordStrengthValidateByControlID("txtMobilePassword", "divMobilePwd");
    });
}

function initMailControls() {
    $("#getMailCode").click(function() {
        if (mailSecond > 0) {
            return
        }
        var b = $("#txtMail");
        if (validateControls([b], "mailErrMsg")) {
            var a = existsTxtMail();
            if (a && a != "") {
                $("#mailErrMsg").text(a);
                return
            }
            sendRegisterMail($.trim(b.val()));
        }
    });
    $("#txtMailPassword").keyup(function() {
        passwordStrengthValidateByControlID("txtMailPassword", "divMailPwd")
    })
}

function passwordStrengthValidateByControlID(a, e) {
    $("#" + e + " span").removeClass("pwd-active-1");
    var d = $("#" + a);
    var f = $.trim(d.val());
    var g = passwordStrengthValidate(f, d.attr("minlength"));
    if (g == 0) {
        return
    }
    var c = [{
        key: 1,
        value: "first-item"
    },
    {
        key: 2,
        value: "mid-item"
    },
    {
        key: 3,
        value: "last-item"
    }];
    for (var b = 0; b < c.length; b++) {
        if (c[b].key == g) {
            $("#" + e + " ." + c[b].value).addClass("pwd-active-1");
            break;
        }
    }
}
function passwordStrengthValidate(e, c) {
    if (e.length < c || e.length == 0) {
        return 0;
    }
    var f;
    var g = [{
        reg: ["^[0-9]*$", "^[A-Za-z]+$", "^\\W+$"],
        text: 1
    },
    {
        reg: ["^[A-Za-z0-9]+$", "^[0-9\\W]+$", "^[a-zA-Z\\W]+$"],
        text: 2
    }];
    for (var a = 0; a < g.length; a++) {
        var d = g[a];
        for (var b = 0; b < d.reg.length; b++) {
            if (isRegex(d.reg[b], e)) {
                f = d.text;
                break;
            }
        }
        if (f) {
            break;
        }
    }
    if (f) {
        return f;
    }
    return 3;
}

function existsControlValue(b, a, c) {
    var d = $.trim($("#" + b).val());
    if (d == "") {
        return
    }
    if (a(d)) {
        return c;
    }
}

function handlerRegisterTitle(b) {
    registerType = $(b).attr("registerType");
    var a = [[b, "active", true], [$(".tab-pane[registerType='" + registerType + "']"), "fn-hide", false]];
    handlerSiblingStatus(a);
}
function submitRegister() {
    if (registerType == 1) {
        mobileRegister();
    } 
}
function mobileRegister1() {
    execByCondition("divMobile", "mobileErrMsg", "/CXZKVIP/usermanage/register/do_register?MOBILE=" + $.trim($("#txtMobile").val()) + "&smsCode=" + $.trim($("#txtSmsCode").val()) + "&PASSWORD=" + getBase64StrAndURIComponent($("#txtMobilePassword").val()) + "&callback=mobileRegisterSucced");
}
function mobileRegister(){
	$.ajax({
        type: "POST",
        url: "/CXZKVIP/usermanage/register/do_register",
        data: {MOBILE:$("#txtMobile").val(), PASSWORD:$("#txtMobilePassword").val(),smsCode:$("#txtSmsCode").val()},
        dataType: "json",
        success: function(data){
                   if (data.IsSuccess){
                	   window.location.href="/CXZKVIP/main/index?rnd="+Math.random(); 
                   }else{
                	   $("#mobileErrMsg").text("短信验证码不正确");
                   }
                 }
    });
}
function mobileRegisterSucced(a) {
    registerSucced(a, "mobileErrMsg");
}

function registerSucced(b, a) {
    if (b.IsSuccess) {
        $("#" + a).text("");
        window.location.href="/CXZKVIP/main/index?rnd="+Math.random(); 
    } else {
        $("#" + a).text(b.Message);
    }
}

function sendRegisterSms(a, c) {
    $.ajax({
        type: "GET",
        url: "/CXZKVIP/usermanage/register/do_sendsms",
        data: {MOBILE:$("#txtMobile").val(), "rand":$("#txtMobileVerify").val()},
        dataType: "json",
        success: function(data){
                   if (data.IsSuccess){
                	   $("#mobileErrMsg").text("");
                       smsSecond = 120;
                       updateSendSmsStatus();
                   }else{
                	   $("#mobileErrMsg").text(a.Message);
                   }
                 }
    });
}


function sendRegisterMail(a) {
	 $.ajax({
	        type: "GET",
	        url: "/CXZKVIP/usermanage/register/do_sendEmail",
	        data: {EMAIL:$("#txtMail").val()},
	        dataType: "json",
	        success: function(data){
	                   if (data.IsSuccess){
	                	   $("#mailErrMsg").text("");
	                	   mailSecond = 120;
	                       updateSendMailStatus();
	                   }else{
	                	   $("#mailErrMsg").text(a.Message);
	                   }
	                 }
	    });
}

function existMobile(b) {
    var a = true;
    var c = "/CXZKVIP/usermanage/register/do_isexisted?";
    c = c + "MOBILE=" + b + "&rnd=" + Math.random();
    $.ajaxSettings.async = false;
    $.getJSON(c,
    function(d) {
        if (d.IsSuccess) {
            a = true;
        } else {
            a = false;
        }
    });
    return a;
}

function verifyimag(b) {
	var a = true;
	var c = "/CXZKVIP/usermanage/register/do_verify?";
		c = c + "rand=" + b +"&rnd=" + Math.random();
	 $.ajaxSettings.async = false;
	    $.getJSON(c,
	    function(d) {
	        if (d.IsSuccess) {
	            a = false;
	        } else {
	            a = true;
	        }
	    });
	    return a;
}


